{% extends "soms/full.html" %}
{% load staticfiles %}
{% block head %}
<script type="text/javascript">
	var selected = false; 
	var selected2 = false;
	var control_selected = false;
	var radius = 7; 
	var nodes = {}; 
	var tracks = {}; 
	var links = {}; 
	var routes = {}; 
	var graphs = []; 
	var mode = "node"; 
	var text = true;
	var move = false;
	var drag = false;
	var thicknessRoute = 2;
	var drag_start = {};
	var drag_center = false;
	var node_color = 'red'; 
	var node_selected_color = '#800'; 
	var track_color = 'black'; 
	var route_color = 'green'; 
	var link_color = 'blue'; 
	var thiknessNode = 1;
	var cursorColor = 'orange';
	var err = 'Error';
	var arrayIP = [];
	var arrIP = '';
	var bgImg = [];
	var upd;
	
	paper.install(window);
	$(document).ready(function() {
		$('body').on('contextmenu', '#networkmap', function(e) {
			return false;
		});
		
		var canvas = document.getElementById('networkmap');
		paper.setup(canvas); 
		paper.view.viewSize.height = $(document).height();  
		paper.view.viewSize.width = $(document).width();; 

		$("#print_control").click(function(){
			var c = document.getElementById("networkmap");
			var dataString = c.toDataURL("image/jpeg", 1.0);
    		window.open(dataString);
		});

		$('#img_edit').click(function(){	
			if (centerIMG) {
				centerIMG.remove();
			}
			cursor.remove();
			paper.view.draw();
			clearAll();
			initAll();
			var c = document.getElementById("networkmap");
			var dataString = c.toDataURL("image/png");
			$('#modalWindow').css('visibility', 'visible');
			var widthCanvas = $('#open_space')[0].scrollWidth;
			var heightCanvas = $('#open_space')[0].scrollHeight;
			var width = widthCanvas;
   			var height = heightCanvas;
   			var IMG = function() {
   				this.width = 0;
   				this.height = 0;
   				this.x = 0;
   				this.y = 0;
   			}
   			IMG.prototype.coordX = function() { return ((this.x + this.width) + this.x) / 2 };
   			IMG.prototype.coordY = function() { return ((this.y + this.height) + this.y) / 2 };
   			IMG.prototype.val = function() {
   				$("#id_imgX").val(this.coordX());
				$("#id_imgY").val(this.coordY());
				$("#id_imgWidth").val(newImage.width);
				$("#id_imgHeight").val(newImage.height);	
   			}
   			IMG.prototype.info = function() {
   				console.log('width: ' + this.width + ' height: ' + this.height);
   				console.log('x: ' + this.coordX() + ' y: ' + this.coordY());   				
   			}
   			var newImage = new IMG();
		    function update(activeAnchor) {
		        var group = activeAnchor.getParent();
		        var topLeft = group.get('.topLeft')[0];
		        var topRight = group.get('.topRight')[0];
		        var bottomRight = group.get('.bottomRight')[0];
		        var bottomLeft = group.get('.bottomLeft')[0];
		        var image = group.get('Image')[0];
		        var anchorX = activeAnchor.getX();
		        var anchorY = activeAnchor.getY();
		        switch (activeAnchor.getName()) {
		            case 'topLeft':
		                topRight.setY(anchorY);
		                bottomLeft.setX(anchorX);
		                break;
		            case 'topRight':
		                topLeft.setY(anchorY);
		                bottomRight.setX(anchorX);
		                break;
		            case 'bottomRight':
		                bottomLeft.setY(anchorY);
		                topRight.setX(anchorX);
		                break;
		            case 'bottomLeft':
		                bottomRight.setY(anchorY);
		                topLeft.setX(anchorX);
		                break;
		        }
		        image.position(topLeft.position());
		        var width = topRight.getX() - topLeft.getX();
		        var height = bottomLeft.getY() - topLeft.getY();
		        if(width && height) {
		            image.width(width);
		            image.height(height);
		        }
		        newImage.width = image.attrs.width
		        newImage.height = image.attrs.height
		    }
		    function addAnchor(group, x, y, name) {
		        var stage = group.getStage();
		        var layer = group.getLayer();
		        var anchor = new Konva.Circle({
		            x: x,
		            y: y,
		            stroke: '#666',
		            fill: '#ddd',
		            strokeWidth: 2,
		            radius: 8,
		            name: name,
		            draggable: true,
		            dragOnTop: false,
		        });
		        anchor.on('dragmove', function() {
		            update(this);
		            layer.draw();
		        });
		        anchor.on('mousedown touchstart', function() {
		            group.setDraggable(true);
		            this.moveToTop();
		        	
		        });
		        anchor.on('dragend', function() {
		            group.setDraggable(true);
		            layer.draw();
		        });
		       
		        anchor.on('mouseover', function() {
		            var layer = this.getLayer();
		            document.body.style.cursor = 'pointer';
		            this.setStrokeWidth(4);
		            layer.draw();

		        });
		        anchor.on('mouseout', function() {
		            var layer = this.getLayer();
		            document.body.style.cursor = 'default';
		            this.setStrokeWidth(2);
		            layer.draw();
		        });
		        group.add(anchor);
		    }
		    var stage = new Konva.Stage({
		        container: 'container',
		        width: width,
		        height: height
		    });
		    var layer = new Konva.Layer();
		    stage.add(layer);
		    var newImg = new Konva.Image({
		        width: 350,
		        height: 220
		    });
		    var NewImgGroup = new Konva.Group({
		        x: 300,
		        y: 200,
		        draggable: true,
		    });
		    var strq = {
		    	x: 1,
		    	y: 1
		    }
		    layer.on('dragend', function() { 
		       	newImage.x = NewImgGroup.attrs.x;
		       	newImage.y = NewImgGroup.attrs.y;
		       	newImage.val();
		    });
		    layer.add(NewImgGroup);
		    NewImgGroup.add(newImg);
		    addAnchor(NewImgGroup, 0, 0, 'topLeft');
		    addAnchor(NewImgGroup, 350, 0, 'topRight');
		    addAnchor(NewImgGroup, 350, 220, 'bottomRight');
		    addAnchor(NewImgGroup, 0, 220, 'bottomLeft');
		    upd = function(url){
		        var imageObj1 = new Image();
			    imageObj1.onload = function() {
			        newImg.image(imageObj1);
			        layer.draw();
			        newImage.width = newImg.attrs.width;
		        	newImage.height = newImg.attrs.height;
		        	newImage.x = NewImgGroup.attrs.x;
		        	newImage.y = NewImgGroup.attrs.y;
		        	newImage.val();
			    };
		  	    imageObj1.src = url;
			}
			
		    $('#container').css({
		    	'background-image': 'url('+ dataString +')',
		    	'background-color': 'tranparent'
		    });
			$("#control_img").load("{% url 'soms:update_for_model' networkmap.id %}");
		});
		$('#exit').click(function() {
			$('#modalWindow').css('visibility', 'hidden');
			drawBGimg();
			drawCursor();
		});

		var centerIMG;
		function drawBGimg(){
			{% if networkmap.images %}
				var backgroundURL = '{{ networkmap.images.url }}';
				var x = Number('{{ networkmap.imgX }}'),
					y = Number('{{ networkmap.imgY }}'),
				    width = Number('{{ networkmap.imgWidth }}'),
					height = Number('{{ networkmap.imgHeight }}');
				centerIMG = new Raster({
					source: backgroundURL,
					position: new Point(x, y)
				});
				centerIMG.on('load', function() {
					centerIMG.size = new Size(width, height);
				});
			{% endif %}			
		}
		drawBGimg();
		var cursor;
		
		function drawCursor(){
			cursor = new Shape.Circle(paper.view.center, radius / 1.5);
			{% if user.is_staff %}
				cursor.fillColor = cursorColor 
			{% endif %} 
		}
		drawCursor();
		$("#id_x").val(Math.round(cursor.position.x));
		$("#id_y").val(Math.round(cursor.position.y));
		
		var track_layer = paper.project.activeLayer;
		var route_layer = new Layer();
		var link_layer = new Layer();
		var node_layer = new Layer();
		var tool = new Tool();
		
		
		tool.onKeyDown = function(event){
			
			if(Key.isDown('q') || Key.isDown('й'))
			{
				if ($('#modify')[0].innerHTML.length == 0) {
					$('#add_control').click();
				}
			}
			else if(Key.isDown('w') || Key.isDown('ц'))
			{			
				if ($('#modify')[0].innerHTML.length == 0) {
					$('#update_control').click();
				}
			}
			else if(Key.isDown('e') || Key.isDown('у'))
			{
				if ($('#modify')[0].innerHTML.length == 0) {
					$('#delete_control').click();
				}
			}
			else if(Key.isDown('r') || Key.isDown('к'))
			{
				if ($('#modify')[0].innerHTML.length == 0) {
					$('#move_control').click();
				}
			}
			else if(Key.isDown('t') || Key.isDown('е'))
			{
				if ($('#modify')[0].innerHTML.length == 0) {
					$('#close_control').click();
				}
			}
		};
		
		
		tool.onMouseDrag = function(event){
			if(!drag) return;
			var dx = (event.event.pageX - drag_start.x) / paper.view.zoom;
			var dy = (event.event.pageY - drag_start.y) / paper.view.zoom;
			paper.view.center = new Point(
				drag_center.x - dx,
				drag_center.y - dy 
			);
		};
		
		
		tool.onMouseUp = function(event){
			if(event.event.button == 2) 
			{
				drag = false; 
				console.log('Left click move = False');
			}
		};
		
		tool.onMouseDown = function(event)
		{
			var hitOptions = {stroke: true, fill: true};
			if (centerIMG !== undefined) centerIMG.selected = false;
			if (event.event.button == 0) {
				if (move && selected && !selected2) {
					moveNode(selected, event.point);
					return;
				}
				if (mode == 'node') {
					cursor.position = event.point;
					$("#id_x").val(Math.round(cursor.position.x));
					$("#id_y").val(Math.round(cursor.position.y));
				}
				else if (mode == 'track' || mode == 'route' || mode == 'link') {выделение ЛКМ узлов при редактировании линий)
					var hitResult = paper.project.hitTest(event.point, hitOptions);
					if (hitResult && hitResult.item && hitResult.item.className == 'Shape' || hitResult.item.className == 'Raster') {hitResult.item.type == 'raster' добавлена возможность выделения ЛКМ узел с картинкой
						if (hitResult.item == selected) selected = false;
						selected2.selected = false;
						selected2.fillColor = node_color;
						selected2 = hitResult.item;
						selected2.selected = true;
						selected2.fillColor = node_selected_color;
						if ($("#track_add").length > 0) $('#add_control').click();
						else if ($('#track_update').length > 0) $('#update_control').click();
						else if ($('#track_delete').length > 0) $('#delete_control').click();
						else if ($("#route_add").length > 0) $('#add_control').click();
						else if ($('#route_update').length > 0) $('#update_control').click();
						else if ($('#route_delete').length > 0) $('#delete_control').click();
						else if ($('#link_add').length > 0) $('#add_control').click();
						else if ($('#link_delete').length > 0) $('#delete_control').click();
					}
				}
			}
			
			
			{% if user.is_staff %}
			
			if (event.event.button == 2) 
			{
				if (move) move = false;
				if (mode == 'node') 
				{
					var hitResult = paper.project.hitTest(event.point, hitOptions);
					if (hitResult && hitResult.item && hitResult.item != cursor && hitResult.item.className != 'path' && hitResult.item.className != 'PointText')
					{
						paper.project.deselectAll();
						selected = hitResult.item;
						hitResult.item.selected = true;
						if ($("#node_add").length > 0) changeForm(selected);
						else if ($('#node_update').length > 0) $('#update_control').click();
						else if ($('#node_delete').length > 0) $('#delete_control').click();
					}
				}
				else if (mode == 'track' || mode == 'route' || mode == 'link') 
				{
					var hitResult = paper.project.hitTest(event.point, hitOptions);
					if (hitResult && hitResult.item.className == 'PointText') return;
					if (hitResult && hitResult.item) 
					{
						if (hitResult.item == selected2) 
						{
							selected2.fillColor = 'red';
							selected2 = false;
						}
						if (hitResult.item.className == 'path')
						{
							selected2.fillColor = 'node_color';
							selected2.selected = false;
							selected2 = false;
						}
						selected.selected = false;
						selected = false;
						selected = hitResult.item;
						hitResult.item.selected = true;
						if ($("#track_add").length > 0) $('#add_control').click();
						else if ($('#track_update').length > 0) $('#update_control').click();
						else if ($('#track_delete').length > 0) $('#delete_control').click();
						else if ($("#route_add").length > 0) $('#add_control').click();
						else if ($('#route_update').length > 0) $('#update_control').click();
						else if ($('#route_delete').length > 0) $('#delete_control').click();
						else if ($('#link_add').length > 0) $('#add_control').click();
						else if ($('#link_delete').length > 0) $('#delete_control').click();
						
					}
				}
			}
			{% endif %}
			if(event.event.button == 1)
			{
				drag = true;
				drag_start.x = event.event.pageX;
				drag_start.y = event.event.pageY;
				drag_center = new Point(paper.view.center);
			}
			return false;
		};
		
		function addTrack(track)
		{
			track_layer.activate();
			new_track = new Path(); 
			new_track.strokeColor = track.fields.color_track; 
			new_track.add(new Point(nodes[track.fields.start_node].soms.fields.x,  
										nodes[track.fields.start_node].soms.fields.y));
			new_track.add(new Point(nodes[track.fields.end_node].soms.fields.x,  
									nodes[track.fields.end_node].soms.fields.y));	
			new_track.soms = track;
			new_track.strokeWidth = track.fields.thickness_track;
			tracks[track.pk] = new_track; 
		}
		
		function addLink(l)
		{ 
			link_layer.activate();
			new_link = new Path();
			new_link.strokeColor = link_color;
			new_link.add(new Point(nodes[l.fields.start_node].soms.fields.x,
									nodes[l.fields.start_node].soms.fields.y));
			new_link.add(new Point(nodes[l.fields.end_node].soms.fields.x,
									nodes[l.fields.end_node].soms.fields.y));
			new_link.soms = l;
			links[l.pk] = new_link;
		}
		
		function addRoute(route)
		{ 
			found = false; 
			for(var i = 0; i < graphs.length; i++){
				graph = graphs[i];
				if(	(graph.soms.fields.start_node == route.fields.start_node &&
					graph.soms.fields.end_node == route.fields.end_node) ||
					(graph.soms.fields.start_node == route.fields.end_node &&
					graph.soms.fields.end_node == route.fields.start_node))
				{
					found = graphs[i];
					break;
				}
			}
			if(found)
			{
				found.soms.routes.push(route.pk);
				route.fields.graph = found;
			}
			else {
				route_layer.activate();
				var new_graph; 
				if(route.fields.start_node == route.fields.end_node){ 
					new_graph = new Path.Circle(new Point(nodes[route.fields.start_node].soms.fields.x, nodes[route.fields.start_node].soms.fields.y), radius + 3 );
					new_graph.strokeColor = route_color;
				}
				else {
					new_graph = new Path(); 
					new_graph.strokeColor = route_color; 
					new_graph.strokeWidth = thicknessRoute;
					new_graph.add(new Point(nodes[route.fields.start_node].soms.fields.x, 
					nodes[route.fields.start_node].soms.fields.y));
					new_graph.add(new Point(nodes[route.fields.end_node].soms.fields.x,
					nodes[route.fields.end_node].soms.fields.y));
				}
				new_graph.soms = {}; 
				new_graph.soms.routes = [];
				new_graph.soms.fields = {'start_node':route.fields.start_node, 'end_node':route.fields.end_node}
				new_graph.soms.routes.push(route.pk);
				route.fields['graph'] = new_graph;
				graphs.push(new_graph);
			}
			routes[route.pk] = route;
		}
		
		function addNode(node)
		{
			node_layer.activate(); 
			var x = node.fields.x; 
			var y = node.fields.y; 
			var color = node.fields.color;
				var thiknessNode = node.fields.thickness
				var new_node; 
				var node_type = node.fields.node_type; 
				var img = {{ MEDIA_URL }}+node.fields.image;
				var img_node = '{% static "soms/" %}' + node.fields.image;
				var text = new PointText(); 
				text.content = node.fields.name; 
				if(node_type == 1 && node.fields.image === null)
				{
						new_node = new Shape.Rectangle(new Point(x - radius, y - radius), radius * thiknessNode);
						text.position = new Point(x, y + (radius * thiknessNode) + 3); 

				}
				else if(node_type == 1 && node.fields.image !== null)
				{
						new_node = new Raster(img_node, new Point(x,y));
						text.position = new Point(x, y + (radius * thiknessNode) + 15); 

				}
				if(node_type == 2 && node.fields.image === null)
				{
						new_node = new Shape.Circle(new Point(x, y), thiknessNode * 5.5);
						text.position = new Point(x, y + (radius * thiknessNode) + 3); 

				}
				else if(node_type == 2 && node.fields.image !== null)
				{
						new_node = new Raster(img_node, new Point(x,y));
						text.position = new Point(x, y + (radius * thiknessNode) + 15); 
				}
				if(node_type == 3 && node.fields.image === null)
				{
						new_node = new Shape.Circle(new Point(x, y), thiknessNode * 5.5);
						text.position = new Point(x, y + (radius * thiknessNode) + 3); 

				}
				else if(node_type == 3 && node.fields.image !== null)
				{
						new_node = new Raster(img_node, new Point(x,y));
						text.position = new Point(x, y + (radius * thiknessNode) + 15); 

				}
				
				
				{
						new_node.strokeColor = 'black';	
					new_node.strokeWidth = 3; 
				}
				new_node.fillColor = color;

				
				new_node.soms.text = text; 
				nodes[node.pk] = new_node;
			}	
			$("#update_control").click(function(){
				if(move) move = false;
				if(mode == 'node')
				{
		
						$("#modify").load("{% url 'soms:node:index' %}"+selected.soms.pk+"/");
				}
				if(mode == 'track')
				{
					if(selected && selected.type == 'path')
						$("#modify").load("{% url 'soms:track:index' %}"+selected.soms.pk+"/");
					else $('#modify').html("");
				}
			});

			$('#edit_model').click(function() {
					$("#modify").load("{% url 'soms:update_for_model' networkmap.id %}");
			});

			
			$("#move_control").click(function(){
				$('#modify').html("");
				if(!selected) return;
				if(selected2) selected2.selected = false;
				selected2 = false;
				move = true;
				paper.view.draw();
			});
			
			$("#add_control").click(function(){
				if(move) move = false;
				if(mode == 'node')
				{
					$("#modify").load("{% url 'soms:node:add' %}", function(){вызывается функция
						$("#id_x").val(Math.round(cursor.position.x));
						$("#id_y").val(Math.round(cursor.position.y));
						$("#id_network_map [value='{{networkmap.id}}']").attr("selected", "selected");
						$("#id_network_map").parent().css('display', 'none');
					});
				}
				if(mode == 'track')
				{
					if(!selected || !selected2){
						$('#modify').html("");
						return;
					}
					$("#modify").load("{% url 'soms:track:add' networkmap.id %}", function(){
						$("#id_start_node [value='"+selected.soms.pk+"']").attr("selected", "selected");
						$("#id_end_node [value='"+selected2.soms.pk+"']").attr("selected", "selected");
						$("#id_start_node").parent().css('display', 'none');
						$("#id_end_node").parent().css('display', 'none');
					});
				}
				if(mode == 'link')
				{
					if(!selected || !selected2 || selected.soms.fields.control_manager == false){
						$('#modify').html("");
						return;
					}
					$("#modify").load("{% url 'soms:link:add' networkmap.id %}", function(){
						$("#id_start_node [value='"+selected.soms.pk+"']").attr("selected", "selected");
						$("#id_end_node [value='"+selected2.soms.pk+"']").attr("selected", "selected");
						$("#id_start_node").parent().css('display', 'none');
						$("#id_end_node").parent().css('display', 'none');
					});
				}
				if(mode == 'route')
				{
					var fpk;
					if(!selected){
						$('#modify').html("");
						return;
					}
					else if(!selected2){
							fpk = selected.soms.pk;
					}
					else fpk = selected2.soms.pk;
					
					$("#modify").load("{% url 'soms:route:add' %}"+selected.soms.pk+"/"+fpk+"/", function(){
					});
				}
			});
			
			$("#text_control").click(function(){
				text = !text;
				for(node in nodes) {
					if(text) nodes[node].soms.text.visible = true;
					else nodes[node].soms.text.visible = false;
				}
				paper.view.draw();
			});
			
			
				
				
				
			
			
			$("#close_control").click(function(){
				$('#modify').html("");
				if(selected){
					selected.selected = false;
					selected = false;
				}
				if(selected2){
					selected2.selected = false;
					selected2.fillColor = node_color;
					selected2 = false;
				}
				clearPath();
				paper.view.draw();
			});
			
			$(document).on('submit', '#networkmap_update', function(){
				var fd = new FormData;
				fd.append('img', $input.prop('files')[0]);
				id = $(this).attr('id'); 
				$.ajax({ 
					
					url: $(this).attr('action'),
					data: $(this).serialize(),
					data: fd,
					type: 'POST', 
					async: true,
					enctype: "multipart/form-data",
					
					success: function(response, status, xhr){
						
						var ct = xhr.getResponseHeader("content-type") || "";
						if(ct.indexOf('json') > -1) {
						if(id == 'networkmap_update')
							{
								clearAll();
								initAll();
								return false;
							}
						$('#modify').html("");
							paper.view.draw();	
						}
					}
				});
				return false;
			});
			$(document).on('submit', 'form', function(){
				
				
				
				id = $(this).attr('id'); 
				$.ajax({ 
					
					url: $(this).attr('action'),
					data: $(this).serialize(),
					type: 'POST', 
					async: true,
					enctype: "multipart/form-data",
					success: function(response, status, xhr){
						
						var ct = xhr.getResponseHeader("content-type") || "";
						if(ct.indexOf('html') > -1) {
							$("#modify").html(response);
							$("#id_network_map").parent().css('display', 'none');
							$("#id_start_node").parent().css('display', 'none');
							$("#id_end_node").parent().css('display', 'none');
						}
						if(ct.indexOf('json') > -1) {
							if(id == 'node_add')
							{
								addNode(response[0])
							}
							if(id == 'node_update') 
							{
								clearAll();
								initAll();
								return false;
							}
						if(id == 'node_delete')
							{
								clearAll();
								initAll();
								return false;
							}
							if(id == 'track_add')
							{
								addTrack(response[0]);
							}
							if(id == 'link_add')
							{
								addLink(response[0]);
							}
							if(id == 'track_update')
							{
								tracks[response[0].pk].soms = response[0];
							}
							if(id == 'track_delete')
							{
								removeTrack(control_selected.soms);
							}
							if(id == 'link_delete')
							{
								removeLink(control_selected.soms);
							}
							if(id == 'route_add')
							{
								addRoute(response[0]);
							}
							if(id == 'route_delete')
							{
								clearRoute();
								initRoute();
								return false;
							}
							$('#modify').html("");
								paper.view.draw();	
						}
					}
				});
				return false;
			});
			
			function randomInt(min, max) {
				var rand = min - 0.5 + Math.random() * (max - min + 1)
				rand = Math.round(rand);
					return rand;
			}
			var aaa = [];
			var id_node = [];
			var node_type = [];
			var name_node = [];
			{% for node in q %}
				aaa.push('{{ node.ip }}');
				id_node.push('{{ node.id }}');
				name_node.push('{{ node.name }}');
				node_type.push('{{ node.node_type }}');
			{% endfor %}
			function randomIP(){
				function random(){
					return (1+(Math.random()*255))|0 
					}
				return [random(),random(),random(),random()].join(".");
			}
			
			function CheckRandomIP() {
				function checkArray(originalArr, checkArr){
				    for(var i=0; i<checkArr.length; i++){
				        if(originalArr.indexOf(checkArr[i]) == -1) return false;
				    }
				    return true;
					}
				var IP = [], 
					checkCurrentIP = [];
				var jj = randomIP(), 
					jq = randomIP();
				var rand = IP.push(jj), 
					rand = checkCurrentIP.push(jq);  
				if (checkArray(aaa, IP) === false) {
					return jj;
				}
				else if (checkArray(aaa, IP) === true) {
					return jq;
				} 
			}

			
			$(document).on('click', '#default_control', function(){
				if(mode == 'node') 
				{
					var element = {
						soms:
						{
							fields:
							{
								thickness: 1,
								popularity: randomInt(1,100),
								cpu: randomInt(1,100),
								ip: CheckRandomIP(),
								output_bandwidth: randomInt(1,100),
								input_bandwidth: randomInt(1,100),
								users: randomInt(1,100),
								memory: randomInt(1,100),
								max_users: randomInt(1,100),
								node_type: 1,
							}
						}
					};
					changeForm(element);
				}
			});
			
			function changeForm(element)
			{
				if(mode == 'node')
				{
					for(field in element.soms.fields)
					{
						var value = element.soms.fields[field];
						
						if($.inArray(field, ['name', 'x', 'y']) != -1) continue;
						if($('#id_' + field).attr('type') == 'checkbox')
						{
							if(value)
								$('#id_' + field).prop('checked', 'checked');
							else
								$('#id_' + field).prop('checked', null);
						}
						$('#id_' + field).val(value);
					}
				}
			}

			
			function moveNode(node, point)
			{
				
				x = Math.round(point.x);
				
				y = Math.round(point.y); 
				
				
				$.getJSON("{% url 'soms:node:move' %}"+node.soms.pk+"/"+x+"/"+y+"/", function(response){ 
						node.position = point;
						node.soms.text.position = new Point(point.x, point.y + radius * 2);
						for(track in tracks){ 
							if(tracks[track].soms.fields.start_node == node.soms.pk)
							tracks[track].segments[0].point = point;
							if(tracks[track].soms.fields.end_node == node.soms.pk)
							tracks[track].segments[1].point = point;
						}
						for(track in links){
							if(links[track].soms.fields.start_node == node.soms.pk)
							links[track].segments[0].point = point;
							if(links[track].soms.fields.end_node == node.soms.pk)
							links[track].segments[1].point = point;
						}
						for(graph in graphs){
							if(graphs[graph].soms.fields.start_node == node.soms.pk)
							{
								if(graphs[graph].soms.fields.start_node == graphs[graph].soms.fields.end_node)
									graphs[graph].position = point;
								else graphs[graph].segments[0].point = point;
							}
							if(graphs[graph].soms.fields.end_node == node.soms.pk)
							{
								if(graphs[graph].soms.fields.start_node == graphs[graph].soms.fields.end_node)
									graphs[graph].position = point;
								else graphs[graph].segments[1].point = point;
							}
						}
						node.soms.fields.x = point.x;
						node.soms.fields.y = point.y;
				});
			}

			
			function removeNode(node)
			{
				nodes[node.pk].soms.text.remove(); 
				nodes[node.pk].remove();
				delete nodes[node.pk];
			}

			
			function removeTrack(track)
			{
				tracks[track.pk].remove(); 
				delete tracks[track.pk];
			}
			
			function removeLink(l)
			{ 
				links[l.pk].remove();
				delete links[l.pk];
			}

			
			function removeRoute(element, route)
			{ 
				var index = element.soms.routes.indexOf(route.pk)
				element.soms.routes.splice(index, 1);
				if(element.soms.routes.length == 0) element.remove();
				delete routes[route.pk];
			}

			
			function clearPath()
			{
				for(i = 0; i < graphs.length; i++)
					graphs[i].strokeColor = route_color;
			}

			
			function drawPath(path)
			{
				for(i = 0; i < path.length; i++) {
					routes[path[i]].fields.graph.strokeColor = '#00F';
				}
			}

			
			$(document).on('change', "#id_parent", function(){ 
				var index = $(this).val();
				if(index == ""){
					$('#id_quality').val("");
					$('#id_bandwidth').val("");
					$('#id_name').val("");
					if(selected.soms.fields.node_type == 1)
					{
						$('#id_quality').prop('readonly', false);
						$('#id_bandwidth').prop('readonly', false);
						$('#id_name').prop('readonly', false);
					}
					clearPath();
						paper.view.draw();
					return;
				}
				$.getJSON("{% url 'soms:route:detail' %}" + index, function(data){
					clearPath();
					drawPath(data);
					$('#id_quality').val(routes[index].fields.quality);
					$('#id_bandwidth').val(routes[index].fields.bandwidth);
					$('#id_name').val(routes[index].fields.name);
					if(selected2){
						$('#id_quality').prop('readonly', true);
						$('#id_bandwidth').prop('readonly', true);
						$('#id_name').prop('readonly', true);
					}
						paper.view.draw();
				});
			});

			$("#mode").change(function(){
				mode = false;
				clearPath();
				for(node in nodes) {
					nodes[node].visible = true;
					if(text) nodes[node].soms.text.visible = true;
					else nodes[node].soms.text.visible = false;
				}
				for(track in tracks) tracks[track].visible = false;
				for(graph in graphs) graphs[graph].visible = false;
				for(l in links) links[l].visible = false;
				cursor.visible = true;
				mode = $(this).val();
				if(mode == 'node'){
									for(track in tracks) tracks[track].visible = true;

				}
				else if(mode == 'track'){
					for(track in tracks) tracks[track].visible = true;
					cursor.visible = false;
				}
				else if(mode == 'link'){
					for(l in links) links[l].visible = true;
					for(node in nodes)
						if(nodes[node].soms.fields.node_type == 3) {
								nodes[node].visible = false;
							nodes[node].soms.text.visible = false;
						}
					cursor.visible = false;
				}
					else if(mode == 'route'){
					for(node in nodes)
						if(nodes[node].soms.fields.node_type == 3) {
								nodes[node].visible = false;
							nodes[node].soms.text.visible = false;
						}
					for(graph in graphs) graphs[graph].visible = true;
					cursor.visible = false;
				}
				paper.project.deselectAll();
				selected = false;
				selected2 = false;
				$('#modify').html("");
					paper.view.draw();
			});

			
			$("#delete_control").click(function(){
				
				if(move){
					move = false;
				}
				
				if(mode == 'node')
				{
					
					if(selected)
					{
						
						$("#modify").load("{% url 'soms:node:index' %}"+selected.soms.pk+"/delete/");
						control_selected = selected;
					}
					
					else $('#modify').html("");
				}
				
				else if(mode == 'track') {
					
					if(selected && selected.className == 'Path')
					{
						
						$("#modify").load("{% url 'soms:track:index' %}"+selected.soms.pk+"/delete/");
						control_selected = selected;
					}
					else $('#modify').html("");
				}
				
				else if(mode == 'link') {
					
					if(selected && selected.className == 'Path')
					{
						
						$("#modify").load("{% url 'soms:link:index' %}"+selected.soms.pk+"/delete/");
						control_selected = selected;
					}
					else $('#modify').html("");
				}
				
				else if(mode == 'route')
				{
					
					if(selected && selected.className == 'Path')
					{
						
						$("#modify").load("{% url 'soms:route:delete' %}"+selected.soms.fields.start_node+"/"+selected.soms.fields.end_node+"/");
						control_selected = selected;
					}
					else $('#modify').html("");
				}
			});


			initAll();
			function initAll() { 
				$.getJSON("{% url 'soms:networkmap_node_json' networkmap.id %}", function(data){ 
						for(i = 0; i < data.length; i++) {
							addNode(data[i]);
						}
						$.getJSON("{% url 'soms:networkmap_track_json' networkmap.id %}", function(data){ 
							for(i = 0; i < data.length; i++) {
								addTrack(data[i]);
							}
							$.getJSON("{% url 'soms:networkmap_route_json' networkmap.id %}", function(data){ 
								for(i = 0; i < data.length; i++) {
									addRoute(data[i]);
								}
								$.getJSON("{% url 'soms:networkmap_link_json' networkmap.id %}", function(data){ менеджера управления
									for(i = 0; i < data.length; i++) {
										addLink(data[i]);
									}
									$("#mode").change();зафиксировано.
								});
							});
						});
				});
			}

			function initRoute()
			{  
				$.getJSON("{% url 'soms:networkmap_route_json' networkmap.id %}", function(data){
					for(i = 0; i < data.length; i++) {
						addRoute(data[i]);
					}
					$("#mode").change();
				});
			}
			
			function clearAll()
			{
				
				for(node in nodes) { 
					nodes[node].remove();
					nodes[node].soms.text.remove();
				}
				
				for(track in tracks) {
					tracks[track].remove();
				}
				
				for(graph in graphs) {
					graphs[graph].remove();
				}
				
				nodes = {};
				tracks = {};
				routes = {};
				graphs = [];
			}

			function clearRoute()
			{
				for(graph in graphs) graphs[graph].remove();
				routes = {};
				graphs = [];
			}

			$('#networkmap').mousewheel(function()
			{
				var z = paper.view.zoom;
				var kart = paper.view.zoom;
				if(event.deltaY < 0) {
					if(z >= 0.2) paper.view.zoom = z - 0.1; 
				}
				else {
					if(z <= 2) paper.view.zoom = z + 0.1; 
				}
			});

		});
</script>
{% endblock %}
{% block content %}
	<canvas id="networkmap"></canvas>
	{% if user.is_staff %}
		<div id="controls">
			<p>
				 <select id="mode">
					<option value="node">Редактор Узлов</option>
					<option value="track">Редактор Топологии</option>
					<option value="route">Редактор Путей</option>
					<option value="link">Редактор Менеджеров Управления</option>
				</select>				<label>

				</label>
			</p>
			<p>
				<button id="add_control">Добавить</button>
				<button id="update_control">Изменить</button>
				<button id="delete_control">Удалить</button>
				<button id="move_control">Переместить</button>
				<button id="close_control">x</button>
			</p>
		</div>
		<div id="modify"></div>
	{% endif %}
	<div id="modalWindow">
		<div id="open_space">
			  <div id="container"></div>

			<div id="control_img">	

			</div>
			<input type="button" id="exit" value='Exit' style="z-index: 8888">			
		
		</div>
	</div>
	<div id="misc_controls">
		{% if user.is_staff %}
			<button id="text_control">Скрыть текст</button>
			<button id="img_edit">Редактирование модели</button>
		{% endif %}
		<button id="print_control">Сделать скриншот</button>
	</div>
	<div id="navigation_controls">
		<a href="{% url 'soms:index' %}">
			<img src="{% static 'img/back.png' %}" width="45px;" />
		</a>
		{% if user.is_staff %}
			<a href="{% url 'loms:add' %}">
				<img src="{% static 'img/forward.png' %}" width="45px;"/>
			</a>
		</div>
	{% endif %}
{% endblock %}
